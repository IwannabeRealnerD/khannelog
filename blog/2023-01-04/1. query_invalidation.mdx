---
title: React Query - selectì™€ Optimistic Update
slug: query-invalidation-rq
authors: khanne
tags: [react query]
---

## âš½ï¸ ëª©í‘œ

---

:::info useQueryì‚¬ìš© ì‹œ selectë¡œ ë°±ì•¤ë“œë¡œ ë¶€í„° ë°›ì•„ì˜¤ëŠ” ë°ì´í„°ë¥¼ ì •ì œí•˜ì—¬ ì‚¬ìš©í•˜ê³  ìˆë˜ ì¤‘, Optimistic Updateë¡œ ë¶€ë”ªí˜€ ë²„ë¦° ë¶ˆì§€ì˜¥
:::

- ~~ì‚´ë©´ì„œ ì²˜ìŒìœ¼ë¡œ ì†Œì£¼ê°€ ë¨¹ê³  ì‹¶ì–´ì¡Œë‹¤.~~ -> ë’¤ëŒì•„ë³´ë©´ ì•„ë¬´ê²ƒë„ ì•„ë‹ˆì˜€ìœ¼ë‚˜ ì™œì´ë ‡ê²Œ í˜ë“¤ê²Œ ëŠê»´ì¡Œì„ê¹Œ?

<!--truncate-->

## ğŸ”Â TLDR;

---

> selectë¡œ ì •ì œëœ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ Optimistic Updateë¥¼ ìˆ˜í–‰í•˜ëŠ”ê²Œ ì•„ë‹ˆë¼ select ì´ì „ ì›ë³¸ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ Optimistic Updateë¥¼ ìˆ˜í–‰í•´ì•¼í•¨

- ì–´ë””ì„œë„ ì œëŒ€ë¡œ ì¨ìˆì§€ ì•Šì•˜ë‹¤.
- ì´ ì§§ì€ í•œêµ¬ì ˆì„ ì œì™¸í•˜ê³¤ -> It affects the returned data value, but does not affect what gets stored in the query cache.

## ì–´ë–»ê²Œ êµ´ëŸ¬ê°€ê³  ìˆë‹ˆ?

---

:::note selectorë¡œ useQuery ë°ì´í„°ë¥¼ ë³€í˜•í•´ì„œ ì‚¬ìš©í•˜ê³  ìˆìœ¼ë©° ê²Œì‹œê¸€ ì‚­ì œ ì‹œ Optimistic Updateë¥¼ í™œìš©í•´ ê²Œì‹œê¸€ì„ ì‚­ì œí•˜ëŠ” í˜„ì¬ ìƒí™©,
:::

### ì„œë²„ì—ì„œ ìƒí•˜ì°¨ë¡œ ë‚´ë ¤ì˜¤ëŠ” ë°ì´í„°ë“¤ì˜ í˜•íƒœ

```tsx
interface PostDef {
  posting_id: number;
  posting_title: string;
  posting_author: string;
  posting_content: string;
}
```

- ë°±ì—”ë“œì—ì„œ ë¸Œë¼ìš°ì €ë¡œ ì „ë‹¬í•´ì£¼ëŠ” ë°ì´í„° í˜•íƒœ
- idë¥¼ ì œì™¸í•˜ê³¤ ë°ì´í„°ê°€ ìŠ¤ë„¤ì´í¬ ì¼€ì´ìŠ¤ë¡œ ìƒí•˜ì°¨ë˜ì–´ ë‚´ë ¤ì˜¤ëŠ” ìƒí™©

```tsx
interface ChangedDef {
  postingId: number;
  title: string;
  author: string;
  content: string;
}
```

- useQueryì˜ ê²°ê³¼ ê°’ì¸ dataì—ì„œ ì‹¤ì œë¡œ ì‚¬ìš© í•  ìˆ˜ ìˆëŠ” ë°ì´í„° í˜•íƒœ
- í”„ë¡ íŠ¸ì—ì„  `ChangedDef` í˜•íƒœë¡œ ë³€í˜•í•´ì„œ ì‚¬ìš©í•´ì•¼í•˜ëŠ” ìƒí™©

### useGetPostArr.tsx

```tsx
// ...ìƒëµ...
const getPostArr: GetPostArrDef = async () => {
  const { data } = await axios.get("http://localhost:3005/posting");
  return data;
};

export const useGetPostArr = () =>
  useQuery(postingArrKeyObj.postingArr, getPostArr, {
    select: (data) => postingArrSelector(data),
  });
```

- í¬ìŠ¤íŒ…ì„ ë¶ˆëŸ¬ì˜¤ëŠ” í›…
- `postingArrSelector`ì—ì„œ ë°ì´í„°ë¥¼ ë³€í™˜í•˜ì—¬ ì‚¬ìš©í•˜ëŠ” ì¤‘

## í•´ê²°ë²•

---

### ë¬¸ì œì ì€?

> selectì—ì„œ ë³€í™”ë˜ê³  ë‚œ í›„ì˜ ê°’ì„ ì°¸ì¡°í•˜ë ¤ í–ˆë˜ ê²ƒ

- ê³µì‹ë¬¸ì„œì—ë„ ë‚˜ì™€ìˆë‹¤ ì‹¶ì´ ~~(Direct í•˜ì§€ ì•Šê³  ë„ˆë¬´ ì›ë¡ ì ì¸ ì„¤ëª…ì´ë¼ê³  ì°¡ì°¡ëŒ€ì§€ ë§ì)~~ `ë°˜í™˜ëœ ë°ì´í„° ê°’ì—ë§Œ ì˜í–¥ì„ ë¼ì¹˜ê³  ì¿¼ë¦¬ ìºì‹œì—ëŠ” ì˜í–¥ì„ ë¼ì¹˜ì§€ ì•ŠëŠ”ë‹¤.`
- setQueryDataì— íƒ€ì…ì„ ì§€ì •í•˜ì§€ ì•Šê³  unkownì¸ ìƒíƒœë¡œ ê·¸ëƒ¥ ê³„ì† ì“°ë ¤í–ˆë˜ê²ƒ.
  - **íƒ€ì… ì§€ì •ì˜ ì†Œì¤‘í•¨**ì„ ë‹¤ì‹œ í•œë²ˆ ê¹¨ë‹¿ê²Œëœë‹¤.
  - íƒ€ì… ì§€ì •ë˜ëŠ” ì¶”ë¡ .

### useDeletePost.tsx

```tsx
// ... ìƒëµ ...
export const useDeletePost = () => {
  const queryClient = useQueryClient();

  return useMutation(deletePost, {
    onMutate: async (requestObj) => {
      await queryClient.cancelQueries(postingArrKeyObj.postingArr);
      const previousData = queryClient.getQueryData(
        postingArrKeyObj.postingArr
      );

      queryClient.setQueryData<PostDef[]>(
        postingArrKeyObj.postingArr,
        (oldPostArr) => {
          if (!oldPostArr) return undefined;

          // selectorë¡œ ë³€í™˜ëœ ê°’ì¸ postingIdê°€ ì•„ë‹Œ ë³€í™˜ë˜ê¸° ì „ ê°’ posting_idë¡œ ì°¸ì¡°ê°€ëŠ¥
          const filteredArr = oldPostArr.filter(
            (oldPost) => oldPost.id !== requestObj.id
          );
          return [...filteredArr];
        }
      );

      return { previousData, requestObj };
    },
  });
};
```

## ì°¸ì¡°

---

[Github - ì˜ˆì œ ì½”ë“œ](https://github.com/IwannabeRealnerD/nextjs-playground)

[TanStack Query - useQuery](https://tanstack.com/query/v4/docs/reference/useQuery?from=reactQueryV3&original=https://react-query-v3.tanstack.com/reference/useQuery)

[React Query Data Transformations](https://tkdodo.eu/blog/react-query-data-transformations)
